#!/bin/bash -e

exec 3>&1
exec 1>&2

payload=$(mktemp /tmp/resource-out.XXXXXX)

cat > "${payload}" <&0

api_token="$(jq -r '.source.api_token' < "${payload}")"
project_id="$(jq -r '.source.project_id' < "${payload}")"

story_labels=$(jq -r '.params.story_labels // []' < $payload)
story_name="$(jq -r '.params.story_name' < "${payload}")"
story_type="$(jq -r '.params.story_type' < "${payload}")"
story_estimate="$(jq -r '.params.story_estimate // 0' < "${payload}")"
story_description="$(jq -r '.params.story_description' < "${payload}")"

create_tracker_request_body() {
  cat << EOF
{
  "name": "${story_name}",
  "story_type": "${story_type}",
  "current_state": "started",
  "description": "${story_description}\n\nGenerated by Concourse build ${ATC_EXTERNAL_URL}/teams/${BUILD_TEAM_NAME}/pipelines/${BUILD_PIPELINE_NAME}/jobs/${BUILD_JOB_NAME}/builds/${BUILD_NAME}",
  "labels": ${story_labels}
}
EOF
}

unstart_tracker_request_body() {
  cat << EOF
{
  "current_state": "unstarted"
}
EOF
}

main() {
  create_story_response=$(curl -s -f \
    -H "X-TrackerToken: ${api_token}" \
    -H "Content-Type: application/json" \
    -d "$(create_tracker_request_body)" \
    "https://www.pivotaltracker.com/services/v5/projects/${project_id}/stories"
  )
  story_id="$(jq -r '.id' <<< "${create_story_response}")"

  curl -s -f \
    -X PUT \
    -H "X-TrackerToken: ${api_token}" \
    -H "Content-Type: application/json" \
    -d "$(unstart_tracker_request_body)" \
    "https://www.pivotaltracker.com/services/v5/projects/${project_id}/stories/${story_id}" > /dev/null
}

main

timestamp=$(date +%s)
echo "{\"version\":{\"timestamp\":\"${timestamp}\"}}" >&3
